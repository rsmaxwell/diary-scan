#!/bin/bash

input_fragments="input/fragments"
if [ ! -d "${input_fragments}" ]; then
    echo "directory not found ${input_fragments}"
    exit 1
fi

#-------------------------------------------
# Check, clear and make directories 
#-------------------------------------------
rm -rf temp output
result=$?
if [ ! ${result} -eq 0 ]; then
    echo "Error: $0[${LINENO}]"
    echo "result: ${result}"
    exit 1
fi

mkdir -p "output/html/images" "output/html/css" "output/html/scripts" "output/html/controls"
result=$?
if [ ! ${result} -eq 0 ]; then
    echo "Error: $0[${LINENO}]"
    echo "result: ${result}"
    exit 1
fi

#-------------------------------------------
# Copy the images
#-------------------------------------------
root="/media/NAS/photo/documents/sea-captains-chest"
if [ ! -d "${root}" ]; then
    echo "Error: $0[${LINENO}]"
    echo "root not found: ${root}"
    exit 1
fi

dirs=()
dirs+=('diary-1828-and-1829-and-jan-1830')
dirs+=('diary-1830')
dirs+=('diary-1831')
dirs+=('diary-1832')
dirs+=('diary-1834')
dirs+=('diary-1835')
dirs+=('diary-1836')
dirs+=('diary-1837')
dirs+=('diary-1838')
dirs+=('diary-1839')

#-------------------------------------------
# Copy the images
#-------------------------------------------

for diary in "${dirs[@]}"; do
    echo "---[ manual: ${diary} ]----------------------------"

    sourceDir="${root}/${diary}/metadata/fragments"

    readarray -d '' array < <(find ${sourceDir} \( -iname "*.jpeg" -or -iname "*.jpg" -or -iname "*.png" \) -print0)
    for image in "${array[@]}"; do

        if [[ "${image}" == *"/@eaDir/"* ]]; then
            continue
        fi

        cp -r ${image} output/html/images/
        result=$?
        if [ ! ${result} -eq 0 ]; then
            echo "Error: $0[${LINENO}]"
            echo "result: ${result}"
            echo "make --file \"${makefile}\""
            exit 1
        fi
    done
done

#-------------------------------------------
# Copy the html elements (styles, scripts & control images)
#-------------------------------------------
cp "input/html" "output"
result=$?
if [ ! ${result} -eq 0 ]; then
    echo "Error: $0[${LINENO}]"
    echo "result: ${result}"
    echo "file: ${file}"
    echo "target: ${target}"
    exit 1
fi

#-------------------------------------------
# Generate the HTML documents from the fragments 
#-------------------------------------------
for dir in output/fragments/*; do
    [ -d "${dir}" ] || continue

    year=$(basename ${dir})

    echo "generating diary for year: ${year}"
    ./generate input output ${year}
    result=$?
    if [ ! ${result} -eq 0 ]; then
        echo "Error: $0[${LINENO}]"
        echo "result: ${result}"
        exit 1
    fi
done

#-------------------------------------------
# Generate an index.html pointing to the diaries
#-------------------------------------------
cat << EOF > output/html/index.html
<!DOCTYPE html>
<html>

<body>

<h1>Diaries</h1>

<ul>
    <li><a href="1828.html">1828</a><br>
    <li><a href="1829.html">1829</a><br>
    <li><a href="1830.html">1830</a><br>
    <li><a href="1831.html">1831</a><br>
    <li><a href="1832.html">1832</a><br>
</ul>


</body>
</html>

EOF
