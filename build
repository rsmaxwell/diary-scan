#!/bin/bash



function copyFragment() {

    fragment=$1
    if [ -z "${fragment}" ]; then
        echo "Error: $0[${LINENO}]"
        echo "No fragment argument supplied"
        exit 1
    fi

    if [ ! -d "${fragment}" ]; then
        echo "Error: $0[${LINENO}]"
        echo "result: ${result}"
        echo "dir not found: ${fragment}"
        exit 1
    fi

    year=$(jq '.year' "${fragment}/fragment.json")
    result=$?
    if [ ! ${result} -eq 0 ]; then
        echo "Error: $0[${LINENO}]"
        echo "result: ${result}"
        echo "fragment: ${fragment}"
        exit 1
    fi

    if [ ! -d "${targetFragmentsDir}" ]; then
        echo "Creating ${targetFragmentsDir} for: ${fragment}"
    fi

    targetFragmentsDir="output/fragments/${year}/"
    targetHtmlDir="output/html/"

    # Make sure the target fragment directory exists
    mkdir -p "${targetFragmentsDir}"
    result=$?
    if [ ! ${result} -eq 0 ]; then
        echo "Error: $0[${LINENO}]"
        echo "result: ${result}"
        echo "targetFragmentsDir: ${targetFragmentsDir}"
        exit 1
    fi

    # Make sure the target html exists
    mkdir -p "${targetHtmlDir}"
    result=$?
    if [ ! ${result} -eq 0 ]; then
        echo "Error: $0[${LINENO}]"
        echo "result: ${result}"
        echo "targetHtmlDir: ${targetHtmlDir}"
        exit 1
    fi

    basename=$(basename ${fragment})
    filename="${basename%.*}"
    targetFragment="${targetFragmentsDir}/${filename}"

    for source in "${fragment}"/*; do
        [ -f "${fragment}" ] || continue

        basename=$(basename "${source}")
        extension="${basename##*.}"
        filename="${basename%.*}"

        if [ ${extension,,} ~= "html|json" ]; then 
            target="${targetFragment}/${basename}"
            if [ "${target}" -nt "${source}" ]; then
                : # echo "up-to-date: ${target}"
            else
                echo "updating: ${target}"
                cp "${source}" "${target}"
                result=$?
                if [ ! ${result} -eq 0 ]; then
                    echo "Error: $0[${LINENO}]"
                    echo "result: ${result}"
                    echo "filename: ${filename}"
                    echo "target:   ${target}"
                    exit 1
                fi
            fi
        fi

        if [ ${extension,,} ~= "jpg|jpeg|png" ]; then 
            target="${targetHtmlDir}/images/${basename}"
    
            if [ "${target}" -nt "${source}" ]; then
                : # echo "up-to-date: ${target}"
            else
                echo "updating: ${target}"
                cp "${source}" "${target}"
                result=$?
                if [ ! ${result} -eq 0 ]; then
                    echo "Error: $0[${LINENO}]"
                    echo "result: ${result}"
                    echo "filename: ${filename}"
                    echo "target:   ${target}"
                    exit 1
                fi
            fi
        fi

    done

    makefile="output/temp/${year}.mk"
    if [ ! -f "${makefile}" ]; then
        printf "${year}.html : " > ${makefile}
    fi
    printf "\\\n    ${targetFragment}/fragment.html" >> ${makefile}
    printf "\\\n    ${targetFragment}/fragment.json" >> ${makefile}
    printf "\\\n    ${imageTarget}" >> ${makefile}
}







root="/media/NAS/photo/documents/sea-captains-chest"

dirs=()
dirs+=('diary-1828-and-1829-and-jan-1830')
dirs+=('diary-1830')
dirs+=('diary-1831')
dirs+=('diary-1832')
dirs+=('diary-1834')
dirs+=('diary-1835')
dirs+=('diary-1836')
dirs+=('diary-1837')
dirs+=('diary-1838')
dirs+=('diary-1839')

#-------------------------------------------
# Check, clear and make directories 
#-------------------------------------------
if [ ! -d "${root}" ]; then
    echo "Error: $0[${LINENO}]"
    echo "root not found: [${root}]"
    exit 1
fi

rm -rf temp
result=$?
if [ ! ${result} -eq 0 ]; then
    echo "Error: $0[${LINENO}]"
    echo "result: ${result}"
    exit 1
fi

mkdir -p "output/html/images" "output/html/css" "output/fragments" "temp"
result=$?
if [ ! ${result} -eq 0 ]; then
    echo "Error: $0[${LINENO}]"
    echo "result: ${result}"
    exit 1
fi


#-------------------------------------------
# Export the build timestamp 
#-------------------------------------------
export BUILD_DATE=$(date '+%Y-%m-%d %H:%M:%S')
export BUILD_YEAR=$(date '+%Y')
export BUILD_MONTH=$(date '+%m')
export BUILD_DAY=$(date '+%d')

#-------------------------------------------
# Clear the temporary directory 
#-------------------------------------------
mkdir -p output/temp
result=$?
if [ ! ${result} -eq 0 ]; then
    echo "Error: $0[${LINENO}]"
    echo "result: ${result}"
    echo "make --file \"${makefile}\""
    exit 1
fi

rm -rf output/temp/*
result=$?
if [ ! ${result} -eq 0 ]; then
    echo "Error: $0[${LINENO}]"
    echo "result: ${result}"
    echo "make --file \"${makefile}\""
    exit 1
fi

#-------------------------------------------
# Assemble the fragments
#-------------------------------------------
for i in "${dirs[@]}"; do
    echo "---[ ${i} ]------------"

    # Extract text from the diary word files (*.docx) into html fragments
    for wordFile in "${root}/${i}/metadata/word"/*.docx; do

        basename=$(basename "${wordFile}")
        extension="${basename##*.}"
        filename="${basename%.*}"

        regex="^(img[0-9]{4})(-(left|right))?\.docx$"
        if [[ ! "${basename}" =~ ${regex} ]]; then
            continue
        fi

        imageFile="pages/${i}/${BASH_REMATCH[1]}.jpg"

        makefile="output/dependancies/${filename}.mk"
        if [ -f "${makefile}" ]; then

            # Call 'make' to call the java extract program
            make --file "${makefile}"
            result=$?
            if [ ! ${result} -eq 0 ]; then
                echo "Error: $0[${LINENO}]"
                echo "result: ${result}"
                echo "make --file \"${makefile}\""
                exit 1
            fi
        else
            # Call the 'java' extract program directly
            ./extract "${wordFile}" "${imageFile}"
            result=$?
            if [ ! ${result} -eq 0 ]; then
                echo "Error: $0[${LINENO}]"
                echo "result: ${result}"
                exit 1
            fi
        fi
    done
done

# Terminate the dependancy files, and copy
for makefile in "output/temp/"*; do
    printf "\n" >> ${makefile}

    src="${makefile}"
    trg="output/dependancies/"
    cp "${src}" "${trg}"
    result=$?
    if [ ! ${result} -eq 0 ]; then
        echo "Error: $0[${LINENO}]"
        echo "result: ${result}"
        echo "src: ${src}"
        echo "trg: ${trg}"
        exit 1
    fi
done

#-------------------------------------------
# Copy the manually crafted fragments 
#-------------------------------------------
for diary in "${dirs[@]}"; do

    for fragment in "${root}/${diary}/metadata/fragments"/*; do

        if [ ! -f "${fragment}/fragment.json" ]; then
            continue
        fi

        copyFragment "${fragment}"
        result=$?
        if [ ! ${result} -eq 0 ]; then
            echo "Error: $0[${LINENO}]"
            echo "result: ${result}"
            echo "fragment: ${fragment}"
            exit 1
        fi
    done
done

#-------------------------------------------
# Copy the styles (*.css)
#-------------------------------------------
for file in input/styles/*; do
    [ -f "${file}" ] || continue

    basename=$(basename "${file}")

    target="output/html/css/${basename}"
    if [ "${target}" -nt "${file}" ]; then
        : # echo "up-to-date: ${target}"
    else
        echo "updating: ${target}"
        cp "${file}" "${target}"
        result=$?
        if [ ! ${result} -eq 0 ]; then
            echo "Error: $0[${LINENO}]"
            echo "result: ${result}"
            echo "file: ${file}"
            echo "target: ${target}"
            exit 1
        fi
    fi
done

#-------------------------------------------
# Generate the HTML documents from the fragments 
#-------------------------------------------
set -x
for dir in output/fragments/*; do
    [ -d "${dir}" ] || continue

    year=$(basename ${dir})

    echo "generating diary for year: ${year}"
    ./generate input/templates output ${year}
    result=$?
    if [ ! ${result} -eq 0 ]; then
        echo "Error: $0[${LINENO}]"
        echo "result: ${result}"
        exit 1
    fi
done
set +x
#-------------------------------------------
# Generate an index.html pointing to the diaries
#-------------------------------------------
cat << EOF > output/html/index.html
<!DOCTYPE html>
<html>

<body>

<h1>Diaries</h1>

<ul>
    <li><a href="1828.html">1828</a><br>
    <li><a href="1829.html">1829</a><br>
    <li><a href="1830.html">1830</a><br>
    <li><a href="1832.html">1832</a><br>
</ul>


</body>
</html>

EOF
